flowchart TD
    %% User Input Phase
    A[User Access] --> B[Frontend: /workspace/dub]
    B --> C[DubWorkspace Component]
    C --> D[Start Dubbing Button]
    D --> E{Input Method?}
    
    %% Input Method Selection
    E -->|File Upload| F[Frontend: Video/Audio Upload]
    E -->|URL| G[Frontend: Enter URL YouTube/TikTok/Facebook]
    
    %% URL Download Flow
    G --> H[Backend: /available-formats]
    H --> I[Check Available Formats]
    I --> J[Frontend: Select Quality/Format]
    J --> K[Backend: /download-media]
    K --> L[VideoDownloadService: yt-dlp Download]
    L --> M{Download Success?}
    M -->|No| N[Return Error: Region-restricted/Private]
    M -->|Yes| O[Upload to R2]
    O --> P[Return R2 URL]
    
    %% File Upload Flow
    F --> Q[Upload File to R2]
    Q --> P
    P --> R[Frontend: Start Dubbing]
    
    %% Optional SRT Upload
    R --> S{SRT File?}
    S -->|Yes| T[Upload SRT File]
    S -->|No| U[Skip SRT]
    T --> V[Backend: /video-dub]
    U --> V
    
    %% Job Creation & Credit Reservation
    V --> W[Download File from R2]
    W --> X[Extract Audio if Video]
    X --> Y[CreditService: Reserve Credits]
    Y --> Z{User Type?}
    Z -->|PAYG| AA[Validate Payment Method]
    Z -->|Credit Pack| AB[Check Credit Balance]
    
    AA --> AC[Create Dub Job]
    AB --> AC
    AC --> AD[StatusService: Set PENDING]
    AD --> AE[QueueManager: Enqueue Task]
    
    %% Queue & Worker Processing
    AE --> AF[Redis Queue: dub_queue]
    AF --> AG[Dub Worker: process_dub_task]
    AG --> AH[Mark Job Active]
    
    %% File Validation
    AH --> AI[DubService: Validate Files]
    AI --> AJ{Files Valid?}
    AJ -->|No| AK[Fail Job: file_validation_failed]
    AJ -->|Yes| AL[Status: uploading - 10%]
    
    %% R2 Upload
    AL --> AM[DubService: Upload to R2]
    AM --> AN{Upload Success?}
    AN -->|No| AO[Fail Job: upload_failed]
    AN -->|Yes| AP[Get R2 Audio URL]
    
    %% Audio Separation Phase
    AP --> AQ[Status: separating - 25%]
    AQ --> AR[RunPodService: Submit Separation]
    AR --> AS[Monitor RunPod Job]
    AS --> AT{Separation Success?}
    AT -->|No| AU[Fail Job: separation_failed]
    AT -->|Yes| AV[Download Vocal & Instrument]
    AV --> AW[Status: transcribing - 45%]
    
    %% Dubbing Pipeline Decision
    AW --> AX[SimpleDubbedAPI: process_dubbed_audio]
    AX --> AY[DubbingOrchestrator: Validate Language]
    AY --> AZ[Build DubbingContext]
    AZ --> BA[FlowCoordinator: Determine Flow]
    
    %% Flow Selection
    BA --> BB{Flow Type?}
    BB -->|Fresh Dub| BC[VideoDubFlow]
    BB -->|Resume| BD[ResumeFlow]
    BB -->|Redub| BE[RedubFlow]
    
    %% Fresh Video Dub Flow
    BC --> BF[TranscriptionStep: WhisperX]
    BF --> BG[Status: transcribing - 50%]
    BG --> BH[SpeakerDetectionStep: Pyannote]
    BH --> BI[Status: speaker detection - 55%]
    BI --> BJ[SegmentationStep: AI Split]
    BJ --> BK[Status: segmenting - 60%]
    
    %% Resume/Redub Flows
    BD --> BL[Load Manifest from R2]
    BE --> BL
    BL --> BF
    
    %% Review Mode Check
    BK --> BM{Review Mode?}
    BM -->|Yes| BN[ReviewHandler: Prepare Review]
    BN --> BO[Save Manifest to R2]
    BO --> BP[Status: review_ready - 100%]
    BP --> BQ[Frontend: Review Interface]
    BQ --> BR{User Action?}
    BR -->|Approve| BS[Resume Job]
    BR -->|Edit| BT[Edit Segments]
    BR -->|Cancel| BU[Cancel Job]
    BS --> BV[Voice Cloning Phase]
    BT --> BO
    
    %% Voice Cloning Phase
    BM -->|No| BV
    BV --> BW{Model Type?}
    BW -->|best/medium| BX[Create Voice References]
    BW -->|normal| BY[Skip Voice Creation]
    
    BX --> BZ{Service Type?}
    BZ -->|best| CA[ElevenLabs: Create Voice Clone]
    BZ -->|medium| CB[Fish Audio: Create Voice Clone]
    
    CA --> CC[Assign References to Segments]
    CB --> CC
    BY --> CC
    
    %% Voice Cloning Execution
    CC --> CD[VoiceCloningStep: Start]
    CD --> CE[Status: voice_cloning - 65%]
    CE --> CF[AudioHandler: Split Audio Segments]
    CF --> CG[Parallel Processing: ThreadPoolExecutor]
    
    CG --> CH[For Each Segment]
    CH --> CI{Model Type?}
    CI -->|best| CJ[ElevenLabs: Generate with Speed 1.0]
    CI -->|medium| CK[Fish Audio: Generate Speech]
    CI -->|normal| CL[Local Fish-Speech: Generate]
    
    %% ElevenLabs Speed Control
    CJ --> CM{First Segment?}
    CM -->|Yes| CN{Duration > Expected?}
    CN -->|Yes| CO[Regenerate with Speed 1.2]
    CN -->|No| CP[Cache Speed 1.0]
    CO --> CQ[Cache Speed 1.2]
    CM -->|No| CR[Use Cached Speed]
    
    CQ --> CS[Save Cloned Audio]
    CP --> CS
    CR --> CS
    CK --> CS
    CL --> CS
    CS --> CT[Update Progress: 65-90%]
    CT --> CU{All Segments Done?}
    CU -->|No| CH
    CU -->|Yes| CV[Cleanup Speed Cache]
    
    %% Finalization Phase
    CV --> CW[FinalizationStep: Start]
    CW --> CX[Status: finalizing - 92%]
    CX --> CY[AudioReconstruction: Merge Segments]
    CY --> CZ[Mix with Instrument Audio]
    CZ --> DA{Subtitle Needed?}
    DA -->|Yes| DB[Generate SRT File]
    DA -->|No| DC[Skip Subtitle]
    
    DB --> DD[Upload SRT to R2]
    DC --> DD
    DD --> DE{Video Processing?}
    DE -->|Yes| DF[Merge Audio with Video]
    DE -->|No| DG[Export Audio Only]
    
    DF --> DH[Upload Final Video to R2]
    DG --> DI[Upload Final Audio to R2]
    
    DH --> DJ[Save Manifest to R2]
    DI --> DJ
    DJ --> DK[Status: completed - 100%]
    
    %% Completion
    DK --> DL[CreditService: Complete Billing]
    DL --> DM[EmailHelper: Send Email]
    DM --> DN[Mark Job Inactive]
    DN --> DO[Cleanup Temp Files]
    DO --> DP[Frontend: Job Complete]
    
    %% Frontend Display
    DP --> DQ[Frontend: /workspace/dub]
    DQ --> DR[JobCard Component]
    DR --> DS[Display Status & Progress]
    DS --> DT[Download Options]
    
    %% Download Options
    DT --> DU{Download Type?}
    DU -->|Video| DV[Download Dubbed Video]
    DU -->|Audio| DW[Download Dubbed Audio]
    DU -->|SRT| DX[Download Subtitle File]
    DU -->|Manifest| DY[Download Segment Manifest]
    DU -->|Vocal Only| DZ[Download Vocal Track]
    DU -->|Instrument| EA[Download Instrument Track]
    
    %% Job Management Actions
    DQ --> EB[Job Actions]
    EB --> EC[Delete Job]
    EB --> ED[Share Job Link]
    EB --> EE[Redub to Another Language]
    EB --> EF[Resume/Edit Job]
    EB --> EG[View Segments]
    
    %% Redub Flow
    EE --> EH[Backend: /video-dub/:id/redub]
    EH --> EI[Fetch Manifest from R2]
    EI --> EJ[Create Redub Job ID]
    EJ --> EK[Prepare Redub Context]
    EK --> EL[Queue Redub Task]
    EL --> BB
    
    %% Share Flow
    ED --> EM[Backend: /video-dub/:id/share]
    EM --> EN[Generate Share Token]
    EN --> EO[Create Share Link with Expiry]
    EO --> EP[Return Shareable URL]
    EP --> EQ[Frontend: Display Share Link]
    
    %% Error Handling
    AG --> ER{Processing Error?}
    ER -->|Yes| ES[DubService: Fail Job]
    ES --> ET[CreditService: Refund Credits]
    ET --> EU[Status: failed]
    EU --> EV[EmailHelper: Send Error Email]
    EV --> EW[Frontend: Error Display]
    EW --> EX[Cleanup Resources]
    
    %% Styling with better color combinations
    classDef frontend fill:#3b82f6,stroke:#1e40af,stroke-width:2px,color:#fff
    classDef backend fill:#8b5cf6,stroke:#5b21b6,stroke-width:2px,color:#fff
    classDef service fill:#10b981,stroke:#047857,stroke-width:2px,color:#fff
    classDef storage fill:#f59e0b,stroke:#d97706,stroke-width:2px,color:#fff
    classDef queue fill:#ec4899,stroke:#be185d,stroke-width:2px,color:#fff
    classDef error fill:#ef4444,stroke:#dc2626,stroke-width:2px,color:#fff
    classDef ai fill:#8b5cf6,stroke:#5b21b6,stroke-width:2px,color:#fff
    classDef review fill:#06b6d4,stroke:#0e7490,stroke-width:2px,color:#fff
    classDef download fill:#14b8a6,stroke:#0f766e,stroke-width:2px,color:#fff
    
    class A,B,C,D,E,F,G,J,R,DP,DQ,DR,DS,DT,DU,DV,DW,DX,DY,DZ,EA,EB,EC,ED,EF,EG,EQ,EW,BQ,BR,BT frontend
    class H,K,V,W,X,AC,AD,AI,AM,EH,EI,EJ,EK,EL,EM,EN,EO backend
    class Y,Z,AA,AB,DL,DM,ES,ET,EV service
    class O,P,Q,AL,AP,DD,DH,DI,DJ storage
    class AE,AF,AG,AH queue
    class AK,AO,AU,ER,ES,ET,EU,EX,N error
    class BF,BH,BJ,BX,CA,CB,CJ,CK,CL ai
    class BM,BN,BO,BP,BS,BU review
    class L,M download


